const db = require("../db/queries");

// --- CATEGORIES ---

async function getCategories(req, res) {
  try {
    const categories = await db.getAllCategories();
    res.render("index", { categories: categories });
  } catch {
    res.redirect("/");
  }
}

async function browseCategories(req, res) {
  try {
    const categories = await db.getAllCategories();
    res.render("categories/index", { categories: categories });
  } catch {
    res.redirect("/");
  }
}

async function newCategoryForm(req, res) {
  res.render("categories/new");
}

async function creatNewCategory(req, res) {
  const categoryName = req.body.name;
  try {
    await db.addCategory(categoryName);
    res.redirect("/");
  } catch {
    res.render("categories/new", {
      categoryName: categoryName,
      errorMessage: "Error creating Category",
    });
  }
}

async function renderCategory(req, res) {
  const categoryName = req.params.id;
  const category = await db.getCategoryByName(categoryName);
  const tours = await db.getTourByCategory(categoryName);
  res.render("categories/category", {
    category: category,
    tours: tours,
  });
}

// --- TOURS ---

async function getTours(req, res) {
  try {
    const tours = await db.getAllTours();
    res.render("tours/index", { tours: tours });
  } catch {
    res.redirect("/");
  }
}

async function newTourForm(req, res) {
  try {
    const categories = await db.getAllCategories();
    res.render("tours/new", { categories: categories });
  } catch (e) {
    console.error(e.message);
    res.redirect("/tours");
  }
}

async function creatNewTour(req, res) {
  const { title, description, location, categoryId } = req.body;
  try {
    await db.addTour(title, description, location, categoryId);
    res.redirect("/tours");
  } catch (e) {
    console.error(e.message);
    res.render("tours/new", {
      errorMessage: "Error creating Tour",
    });
  }
}

async function renderTour(req, res) {
  const tourId = req.params.id;
  console.log(tourId);
  try {
    const tour = await db.getTourById(tourId);
    if (tour.length > 0) {
      res.render("tours/tour", {
        tour: tour,
      });
    } else {
      res.redirect("/tours");
    }
  } catch (e) {
    console.error(e.message);
    res.redirect("/tours");
  }
}

module.exports = {
  getCategories,
  browseCategories,
  newCategoryForm,
  creatNewCategory,
  renderCategory,
  getTours,
  renderTour,
  newTourForm,
  creatNewTour,
};
